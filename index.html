<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sauda Booking - MT Transfer Fix</title>
<style>
  :root{
    --bg-main:#ffe4e6;
    --card-bg:#fff;
    --card-radius:22px;
    --card-shadow:0 25px 60px rgba(15,23,42,.18);
    --accent-green:#7cc91a;
    --accent-green-dark:#5ca20b;
    --accent-purple:#ef4444;
    --text-main:#111827;
    --text-muted:#6b7280;
    --field-border:#d1d5db;
  }
  *{box-sizing:border-box;margin:0;padding:0}

  body{
    min-height:100vh;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg-main);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:32px 16px;
    color:#111827;
  }

  .outer-shell{
    width:100%;
    max-width:1180px;
  }

  .container{
    background:#fff;
    border-radius:var(--card-radius);
    box-shadow:var(--card-shadow);
    overflow:visible;
    border:1px solid #e5e7eb;
    transition:transform .3s ease, box-shadow .3s ease;
  }
  .container:hover{
    transform:translateY(-2px);
    box-shadow:0 30px 70px rgba(15,23,42,.22);
  }

  .brand-bar{
    background:linear-gradient(90deg,#b91c1c,#ef4444);
    padding:16px 28px;
    color:#fef2f2;
  }
  .brand-title{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .brand-logo {
    width: 110px;
    height: 58px;
    border-radius: 14px;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 15px;
    color: #b91c1c;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
  }
  .brand-logo:hover {
    transform: translateY(-3px) scale(1.03);
    background: #fff7f7;
    box-shadow: 0 12px 28px rgba(185,28,28,0.35);
  }
  .logo-two-line span {
    line-height: 14px;
    display: block;
  }

  .brand-title h1{
    font-size:22px;
  }

  .content{
    padding:20px 24px 24px;
  }

  h2.section-title{
    font-size:14px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:#9f1239;
    margin:18px 0 8px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  h2.section-title::before{
    content:'';
    width:14px;
    height:4px;
    border-radius:999px;
    background:linear-gradient(90deg,#ef4444,#7cc91a);
  }

  .section-shell{
    background:#fef2f2;
    border-radius:16px;
    padding:14px 16px;
    border:1px solid #fecaca;
    margin-bottom:10px;
    position:relative;
    overflow:visible;
    transition:box-shadow .25s ease,border-color .25s ease,background .25s ease,transform .2s ease;
  }
  .section-shell::before{
    content:"";
    position:absolute;
    inset:-2px;
    border-radius:inherit;
    border:1px solid transparent;
    pointer-events:none;
    transition:border-color .25s ease,opacity .25s ease;
    opacity:0;
  }
  .section-shell:hover{
    box-shadow:0 15px 40px rgba(15,23,42,.16);
    border-color:#fecaca;
    background:radial-gradient(circle at top left,#fee2e2 0,#fef2f2 40%,#ffffff 100%);
    transform:translateY(-1px);
  }
  .section-shell:hover::before{
    border-color:rgba(248,113,113,.7);
    opacity:1;
  }

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:10px;
  }
  .field{
    flex:1 1 220px;
    min-width:180px;
  }
  .field label{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    font-weight:600;
    color:#374151;
    margin-bottom:4px;
  }

  .field input,
  .field select,
  .field textarea{
    width:100%;
    border-radius:999px;
    border:1px solid var(--field-border);
    background:#fef2f2;
    padding:8px 12px;
    font-size:13px;
    transition:border-color .2s ease,box-shadow .2s ease,background .2s ease,transform .12s ease;
  }
  .field textarea{
    border-radius:12px;
    min-height:80px;
    resize:vertical;
  }
  .field input:hover,
  .field select:hover,
  .field textarea:hover{
    border-color:#f97373;
    background:#ffffff;
    box-shadow:0 0 0 1px rgba(248,113,113,.4),0 8px 20px rgba(15,23,42,.08);
    transform:translateY(-1px);
  }
  .field input:focus,
  .field select:focus,
  .field textarea:focus{
    outline:none;
    border-color:#ef4444;
    box-shadow:0 0 0 2px rgba(248,113,113,.5),0 10px 26px rgba(15,23,42,.12);
    background:#ffffff;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:6px;
    font-size:12px;
  }
  th,td{
    border:1px solid #e5e7eb;
    padding:4px;
    text-align:center;
    color:#374151;
  }
  tfoot td{
    background:#fef2f2;
    font-weight:600;
  }

  /* NEW: Highlight the MT column slightly to indicate it is editable */
  td.mtCol input {
    background: #fff7f7;
    border-color: #fca5a5;
  }
  td.mtCol input:focus {
    background: #fff;
    border-color: #ef4444;
  }

  .item-card{
    background:#fff;
    border-radius:16px;
    padding:10px 11px 12px;
    border:1px solid #fecaca;
    box-shadow:0 8px 26px rgba(15,23,42,.08);
    margin-top:10px;
    position:relative;
    overflow:visible;
    transition:box-shadow .22s ease,border-color .22s ease,transform .18s ease,background .22s ease;
  }
  .item-card:hover{
    transform:translateY(-2px);
    border-color:#fecaca;
    box-shadow:0 18px 40px rgba(248,113,113,.35);
    background:radial-gradient(circle at top,#fee2e2 0,#ffffff 45%,#fef2f2 100%);
  }

  .item-card-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:6px;
  }
  .item-label{
    display:flex;
    align-items:flex-start;
    gap:8px;
  }
  .item-label-title{
    font-size:13px;
    font-weight:600;
  }
  .item-label-sub{
    font-size:11px;
    color:#6b7280;
  }
  .item-index-chip{
    width:26px;
    height:26px;
    border-radius:999px;
    background:#fee2e2;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#b91c1c;
    font-weight:700;
    font-size:13px;
    box-shadow:0 4px 12px rgba(248,113,113,.7);
    transition:transform .2s ease, box-shadow .2s ease;
  }
  .item-card:hover .item-index-chip{
    transform:translateY(-1px) scale(1.05);
    box-shadow:0 8px 18px rgba(248,113,113,.9);
  }

  .btn-chip,
  .btn-small,
  .btn-primary,
  .btn-secondary,
  .btn-teal {
    position:relative;
    overflow:hidden;
    transition:transform .12s ease,box-shadow .2s ease,background .2s ease,opacity .2s ease;
    cursor:pointer;
    border:none;
    border-radius:999px;
    font-weight:700;
  }

  .btn-chip{
    border:1px solid #fecaca;
    background:#fef2f2;
    padding:5px 10px;
    font-size:11px;
    color:#7f1d1d;
  }

  .btn-small{
    font-size:12px;
    padding:6px 12px;
    background:#b91c1c;
    color:#f9fafb;
    box-shadow:0 6px 14px rgba(185,28,28,.55);
  }

  .btn-row{
    margin:18px 0 4px;
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
  }

  .btn-primary{
    font-size:13px;
    padding:8px 16px;
    background:linear-gradient(90deg,#ef4444,#b91c1c);
    color:#fef2f2;
    box-shadow:0 8px 18px rgba(185,28,28,.55);
  }
  .btn-secondary{
    font-size:13px;
    padding:8px 16px;
    background:#111827;
    color:#fff;
    box-shadow:0 8px 18px rgba(15,23,42,.6);
  }
  
  .btn-teal {
    font-size:13px;
    padding:8px 16px;
    background:linear-gradient(90deg,#0d9488, #0f766e);
    color:#fff;
    box-shadow:0 8px 18px rgba(13,148,136,.55);
  }

  .btn-chip:hover, .btn-small:hover, .btn-primary:hover, .btn-secondary:hover, .btn-teal:hover {
    transform:translateY(-1px) scale(1.03);
    box-shadow:0 10px 24px rgba(15,23,42,.35);
    opacity:0.96;
  }
  .btn-chip:active, .btn-small:active, .btn-primary:active, .btn-secondary:active, .btn-teal:active {
    transform:translateY(1px) scale(0.97);
    box-shadow:0 4px 10px rgba(15,23,42,.35);
    opacity:0.9;
  }

  .suggestion-box{
    position:fixed;
    left:0;
    top:0;
    background:#fff;
    border:1px solid #fecaca;
    border-radius:8px;
    z-index:9999;
    max-height:240px;
    overflow-y:auto;
    box-shadow:0 8px 20px rgba(248,113,113,.3);
    display:none;
    min-width:240px;
    max-width:360px;
  }
  .suggestion-item{
    padding:8px 10px;
    cursor:pointer;
    font-size:12px;
    display:flex;
    justify-content:space-between;
    gap:8px;
  }
  .suggestion-item .left{color:#111827}
  .suggestion-item .right{color:#6b7280}
  .suggestion-item:hover,
  .suggestion-item.active{
    background:#fee2e2;
  }

  .suggestion-item.add-item-footer{
    justify-content:center;
    font-weight:600;
    border-top:1px solid #fecaca;
    background:#b91c1c;
    color:#fef2f2;
  }
  .suggestion-item.add-item-footer .left{color:#fef2f2}
  .suggestion-item.add-item-footer:hover{
    background:#7f1d1d;
  }

  .table-disabled{opacity:.45;pointer-events:none}
  .hidden{display:none}
  .sizes-footer{margin-top:6px;display:flex;gap:8px}

  .manualToggleWrapper{
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .manualToggleCaption{
    font-size:11px;
    color:#9f1239;
    text-transform:uppercase;
    letter-spacing:.09em;
  }
  .manualQtyToggle{
    -webkit-appearance:none;
    appearance:none;
    position:relative;
    width:88px;
    height:28px;
    border-radius:999px;
    display:inline-block;
    cursor:pointer;
    background:#fee2e2;
    border:1px solid #fecaca;
    box-shadow:inset 0 0 0 1px rgba(248,113,113,.3),0 4px 10px rgba(248,113,113,.25);
    transition:background .22s ease,box-shadow .22s ease,transform .1s ease;
  }
  .manualQtyToggle::after{
    content:"AUTO";
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    font-weight:600;
    letter-spacing:.08em;
    color:#b91c1c;
    text-transform:uppercase;
    pointer-events:none;
  }
  .manualQtyToggle::before{
    content:"";
    position:absolute;
    top:3px;
    left:3px;
    width:24px;
    height:22px;
    border-radius:999px;
    background:#ffffff;
    box-shadow:0 2px 6px rgba(15,23,42,.35);
    transition:transform .22s ease;
  }
  .manualQtyToggle:checked{
    background:linear-gradient(90deg,#fb7185,#b91c1c);
    box-shadow:0 0 0 1px rgba(248,113,113,.7),0 6px 14px rgba(248,113,113,.7);
  }
  .manualQtyToggle:checked::before{transform:translateX(58px);}
  .manualQtyToggle:checked::after{
    content:"MANUAL";
    color:#fef2f2;
  }
  .manualQtyToggle:hover{transform:translateY(-1px);}
  .manualQtyToggle:focus-visible{
    outline:2px solid #fb7185;
    outline-offset:3px;
  }

  .row-manual{
    margin-bottom:6px;
    align-items:flex-end;
  }
  .manualToggleBar{
    display:flex;
    align-items:center;
    gap:12px;
    margin-top:4px;
  }
  .manualModeHint{
    font-size:11px;
    color:#6b7280;
    max-width:260px;
    line-height:1.3;
  }
  .manualModeHint .hint-auto{
    font-weight:700;
    font-size:12px;
    color:#b91c1c;
  }
  
  /* LOADER */
  #loaderOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .spinner { width: 50px; height: 50px; border: 4px solid rgba(220,38,38,0.2); border-left-color: #dc2626; border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 900px){
    body{
      padding:16px 8px;
      align-items:flex-start;
      justify-content:center;
    }
    .outer-shell{
      max-width:100%;
    }
    .container{
      border-radius:16px;
    }
    .content{
      padding:16px 14px 18px;
    }
  }

  /* --- MOBILE VIEW OPTIMIZATION --- */
  @media (max-width: 640px){
    body{ padding:0; }
    .outer-shell{ max-width:100%; }
    .container{ border-radius:0; box-shadow:none; border:none; }
    .brand-bar{ padding:12px 16px; }
    .brand-title h1{ font-size:18px; }
    .content{ padding:12px 10px 16px; }
    h2.section-title{ font-size:12px; margin:12px 0 6px; }
    .section-shell{ padding:10px; border-radius:10px; margin-bottom:8px; }
    .row{ flexDirection:column; gap:8px; margin-bottom:8px; }
    .field{ min-width:100%; flex:1 1 auto; }
    .field label{ font-size:11px; }
    .field input, .field select, .field textarea{ font-size:13px; padding:9px 12px; }
    .item-card{ padding:8px 8px 10px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .item-card-header{ flexDirection:row; alignItems:flex-start; gap:6px; }
    .manualToggleBar{ flexDirection:column; alignItems:flex-start; gap:4px; }
    .manualModeHint{ maxWidth:100%; }
    .suggestion-box{ max-width:90vw; min-width:60vw; }

    .btn-row{ 
      display: flex;
      justify-content:space-between; 
      flex-wrap: wrap; 
      gap: 6px;
    }
    .btn-row button {
      flex: 1 1 45%; 
      padding: 10px 4px; 
      font-size: 11px; 
      white-space: nowrap; 
    }

    .itemTable { display: block; width: 100%; }
    .itemTable thead { display: none !important; }
    .itemTable tbody, .itemTable tfoot { display: block; width: 100%; }

    .itemTable tbody tr {
      display: flex !important; 
      flex-direction: column;
      background: #ffffff;
      border: 1px solid #fecaca;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .itemTable tbody td {
      display: block;
      width: 100% !important;
      border: none;
      padding: 0 0 12px 0;
      text-align: left;
    }
    .itemTable tbody td:last-child { padding-bottom: 0; }
    .itemTable tbody td::before {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: #9f1239;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .itemTable tbody td:nth-child(1) { border-bottom: 1px dashed #fee2e2; margin-bottom: 8px; padding-bottom: 8px; font-weight: 700; color: #374151; }
    .itemTable tbody td:nth-child(1)::before { content: "#"; display: inline-block; margin-right: 6px; color: #6b7280; font-weight: normal; }
    
    .itemTable tbody td:nth-child(2)::before { content: "Size"; }
    .itemTable tbody td:nth-child(3)::before { content: "Per (Kg / Qty)"; }
    .itemTable tbody td.mtCol::before { content: "MT (Input Optional)"; }
    .itemTable tbody td:nth-child(5)::before { content: "Nos"; }
    .itemTable tbody td:nth-child(6)::before { content: "Total Item Qty"; }

    .itemTable input {
      width: 100%;
      padding: 10px 12px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }
    .itemTable input:focus {
      background: #fff;
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
      outline: none;
    }

    .itemTable tfoot tr {
      background: #374151;
      color: #fff;
      border-radius: 8px;
      padding: 12px 14px;
      display: flex !important;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .itemTable tfoot td {
      display: block !important;
      width: auto !important;
      padding: 0;
      border: none;
      background: transparent;
      color: #fff;
      font-weight: 700;
    }
    
    .itemTable tfoot td::before { content: none !important; }
    .sizes-footer { gap: 10px; }
    .sizes-footer button { flex: 1; padding: 12px; justify-content: center; }
  }
</style>
</head>
<body>
<div id="loaderOverlay">
  <div class="spinner"></div>
  <p style="margin-top:16px; font-weight:700; color:#dc2626;">Loading Live Data...</p>
</div>

<div class="outer-shell">
  <div class="container">
    <div class="brand-bar">
      <div class="brand-title">
        <div class="brand-logo logo-two-line">
          <span>Steel</span>
          <span>Mart</span>
        </div>
        <div class="brand-text"><h1>Sauda Booking</h1></div>
      </div>
    </div>

    <div class="content">
      <h2 class="section-title">Basic Details</h2>
      <div class="section-shell">
        <div class="row">
          <div class="field">
            <label for="bookingDate">Booking Date</label>
            <input type="date" id="bookingDate" required>
          </div>

          <div class="field">
            <label for="firmName">Firm Name <span class="sub">Required</span></label>
            <input type="text" id="firmName" placeholder="Enter firm name" required>
          </div>

          <div class="field">
            <label for="vehicleNumber">Vehicle Number</label>
            <input type="text" id="vehicleNumber" placeholder="Enter vehicle number">
          </div>

          <div class="field">
            <label for="totalQtyHeader">Effective Total Qty <span class="sub">Auto Â· MT</span></label>
            <input type="number" id="totalQtyHeader" readonly>
          </div>
        </div>
      </div>

      <h2 class="section-title">Items &amp; Rates</h2>
      <div class="section-shell">
        <div id="itemsContainer"></div>
        <div style="margin-top:8px;">
          <button type="button" class="btn-small" id="addItemBtn">ï¼‹ Add Item</button>
        </div>
      </div>

      <h2 class="section-title">Other Details (optional)</h2>
      <div class="section-shell">
        <div class="row">
          <div class="field" style="flex:1 1 100%;">
            <label for="remarks">Remarks / Notes</label>
            <textarea id="remarks" rows="3" placeholder="Delivery details, quality, etc."></textarea>
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-secondary" onclick="resetForm()">â†º Reset</button>
        <button type="button" class="btn-teal" onclick="shareOnWhatsApp(false)">âš¡ Share Qty Only</button>
        <button type="button" class="btn-primary" onclick="shareOnWhatsApp(true)">ðŸŸ¢ Share Details</button>
      </div>
    </div>
  </div>
</div>

<script>
  // --------------------------------------------------------
  //  CONFIGURATION
  // --------------------------------------------------------
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbzcSBboPXwuH-whwxXe8IdaaTqnTgIPBVo_z1aMJNZuzX2KQq12AL-RjH1znoq3MCex/exec"; 
  // --------------------------------------------------------

  const MAX_ITEMS=25;
  const itemsContainer=document.getElementById('itemsContainer');
  const totalQtyHeader=document.getElementById('totalQtyHeader');
  const addItemBtn=document.getElementById('addItemBtn');
  const bookingDateEl=document.getElementById('bookingDate');
  const loaderOverlay=document.getElementById('loaderOverlay');

  // DYNAMIC DATA VARIABLES
  let CATEGORY_MAP = {};
  let ALL_SIZES = [];
  let ITEM_NAMES = [];

  function num(v){const n=parseFloat(v);return isNaN(n)?0:n;}

  function isoDateOnly(d){
    const z=new Date(d); z.setHours(0,0,0,0);
    return `${z.getFullYear()}-${String(z.getMonth()+1).padStart(2,'0')}-${String(z.getDate()).padStart(2,'0')}`;
  }
  (function initDateField(){
    const today=new Date();
    const todayStr=isoDateOnly(today);
    bookingDateEl.max=todayStr;
    bookingDateEl.value=todayStr;
  })();

  // --- FETCH LIVE DATA & EXTRACT WEIGHT FROM LABEL ---
  async function fetchLiveItems() {
    try {
        if(!SHEET_API_URL) { 
            console.error("SHEET_API_URL is empty. Please update it in the CONFIGURATION section.");
            loaderOverlay.innerHTML = `<p style='color:#dc2626; font-weight:700;'>Error: API URL Not Set.<br>Please ensure the Google Sheets Web App URL is correctly configured.</p>`;
            setTimeout(() => { loaderOverlay.style.display = 'none'; }, 5000); 
            return; 
        }

        const response = await fetch(SHEET_API_URL); 
        if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
        const jsonResponse = await response.json();
        
        const rawItems = jsonResponse.items || [];
        
        // Reset Data
        CATEGORY_MAP = {};
        ALL_SIZES = [];
        ITEM_NAMES = [];

        rawItems.forEach(group => {
            const itemName = group.name;
            if (!itemName) return;

            ITEM_NAMES.push(itemName);
            CATEGORY_MAP[itemName] = [];

            if (group.sizes && Array.isArray(group.sizes)) {
                group.sizes.forEach(s => {
                    let weight = 0;
                    if (s.label) {
                        const matches = s.label.trim().match(/[\s]+(\d+(\.\d+)?)$/);
                        if (matches && matches[1]) {
                            weight = parseFloat(matches[1]);
                        }
                    }
                    
                    CATEGORY_MAP[itemName].push({ label: s.label, weight: weight });
                });
            }
        });

        // Rebuild ALL_SIZES flat list
        ALL_SIZES = Object.entries(CATEGORY_MAP).flatMap(([cat, arr]) =>
            arr.map(o => ({ itemType: cat, label: o.label, weight: o.weight }))
        );

        // Update dropdowns in existing cards
        updateAllDropdowns();

        loaderOverlay.style.display = 'none'; 

    } catch (error) {
        console.error("Error fetching live items:", error);
        loaderOverlay.innerHTML = `<p style='color:#dc2626; font-weight:700;'>Error Loading Data.<br>Check internet connection or API configuration.</p><p style='color:#dc2626; font-size:12px;'>Details: ${error.message || 'Unknown error'}</p>`;
        setTimeout(() => { loaderOverlay.style.display = 'none'; }, 5000); 
    }
  }

  function updateAllDropdowns() {
      document.querySelectorAll('.itemTypeSelect').forEach(select => {
          const currentVal = select.value;
          select.innerHTML = '<option value="">Select Item</option>';
          ITEM_NAMES.forEach(name => {
              const opt = document.createElement('option');
              opt.value = name;
              opt.textContent = name;
              select.appendChild(opt);
          });
          if(ITEM_NAMES.includes(currentVal)) {
              select.value = currentVal;
          }
      });
  }

  // --- SUGGESTION LOGIC ---
  function attachSuggestion(sizeInput, itemTypeSelect, weightInput, card){
    const box=document.createElement('div');
    box.className='suggestion-box';
    document.body.appendChild(box);

    function placeBox(){
      if(box.style.display==='none') return;
      const rect=sizeInput.getBoundingClientRect();
      const vw=window.innerWidth;
      const vh=window.innerHeight;

      box.style.minWidth = rect.width + 'px';

      let left = rect.left;
      let top  = rect.bottom + 4;

      box.style.left = left + 'px';
      box.style.top  = top  + 'px';

      const boxRect = box.getBoundingClientRect();

      if(boxRect.right > vw - 8){
        left = Math.max(8, vw - boxRect.width - 8);
      }

      if(boxRect.bottom > vh - 8){
        top = rect.top - boxRect.height - 4;
        if(top < 8) top = 8;
      }

      box.style.left = left + 'px';
      box.style.top  = top  + 'px';
    }

    function currentList(){
      const sel=itemTypeSelect.value;
      if(sel){
        return (CATEGORY_MAP[sel]||[]).map(o=>({itemType:sel,label:o.label,weight:o.weight}));
      }
      return ALL_SIZES;
    }

    function renderList(list, showItemTag){
      if(!list.length){ box.style.display='none'; return; }
      box.innerHTML='';
      list.forEach(m=>{
        const d=document.createElement('div'); d.className='suggestion-item';
        const leftText = showItemTag ? `[${m.itemType}] ${m.label}` : m.label;
        const rightText = (m.weight && m.weight > 0) ? m.weight : '';
        d.innerHTML = `<span class="left">${leftText}</span><span class="right">${rightText}</span>`;
        d.addEventListener('click',()=>{
          if(!itemTypeSelect.value){ itemTypeSelect.value = m.itemType; updateLabelsForCard(card); }
          const prefix = (m.itemType==='Pipe'||m.itemType==='Angle'||m.itemType==='Channel'||m.itemType==='Flat'||m.itemType==='Sqr Bar') ? `${m.itemType} ` : '';
          sizeInput.value = `${prefix}${m.label}`;
          if(m.weight > 0) weightInput.value = m.weight;
          else weightInput.value = ''; 
          
          recalcItemTotals(card); updateEffectiveTotalQty();
          box.style.display='none';
          
          if(!weightInput.value) weightInput.focus();
        });
        box.appendChild(d);
      });

      const addRow = document.createElement('div');
      addRow.className = 'suggestion-item add-item-footer';
      addRow.innerHTML = `<span class="left">ï¼‹ Add Item</span>`;
      addRow.addEventListener('click', () => {
        box.style.display='none';
        const newCard = addItemCard();
        if(newCard){
          newCard.scrollIntoView({behavior:'smooth', block:'center'});
          const firstSize = newCard.querySelector('.sizeInput');
          if(firstSize) firstSize.focus();
        }
      });
      box.appendChild(addRow);

      box.style.display='block';
      placeBox();
    }

    function filterAndShow(){
      const list = currentList();
      const q = sizeInput.value.trim().toLowerCase();
      const showItemTag = !itemTypeSelect.value;
      const searchPool = list.map(s => ({
        ...s,
        searchText: (showItemTag ? `[${s.itemType}] ${s.label}` : s.label).toLowerCase()
      }));
      const matches = q ? searchPool.filter(s=>s.searchText.includes(q)) : searchPool;
      renderList(matches, showItemTag);
    }

    sizeInput.addEventListener('focus', filterAndShow);
    sizeInput.addEventListener('input', filterAndShow);
    document.addEventListener('click',e=>{
      if(!box.contains(e.target) && e.target!==sizeInput) box.style.display='none';
    });

    sizeInput.addEventListener('keydown',e=>{
      if(box.style.display!=='block') return;
      const items=[...box.querySelectorAll('.suggestion-item')];
      if(!items.length) return;
      let idx=items.findIndex(el=>el.classList.contains('active'));
      if(e.key==='ArrowDown'){
        e.preventDefault();
        items.forEach(el=>el.classList.remove('active'));
        idx=Math.min(idx+1, items.length-1);
        items[idx].classList.add('active');
        items[idx].scrollIntoView({block:'nearest'});
      }else if(e.key==='ArrowUp'){
        e.preventDefault();
        items.forEach(el=>el.classList.remove('active'));
        idx=Math.max(idx-1, 0);
        items[idx].classList.add('active');
        items[idx].scrollIntoView({block:'nearest'});
      }else if(e.key==='Enter'){
        e.preventDefault();
        if(idx>=0){ items[idx].click(); }
      }
    });

    window.addEventListener('scroll',()=>{ if(box.style.display==='block') placeBox(); }, true);
    window.addEventListener('resize',()=>{ if(box.style.display==='block') placeBox(); });

    itemTypeSelect.addEventListener('change', ()=>{
      box.style.display='none';
      filterAndShow();
    });
  }

  function addSizeRow(card){
    const tbody=card.querySelector('tbody');
    const rowIndex=tbody.children.length+1;

    const tr=document.createElement('tr');
    tr.dataset.lastEdited = 'nos';
    // NOTE: Added placeholder to MT input to indicate editability
    tr.innerHTML=`
      <td>${rowIndex}</td>
      <td><input type="text" class="sizeInput" placeholder="Click or type to search"></td>
      <td><input type="number" class="weightInput" step="0.01" min="0"></td>
      <td class="mtCol"><input type="number" class="mtInput" step="any" min="0" placeholder="Type MT..."></td>
      <td><input type="number" class="nosInput" step="1" min="0"></td>
      <td><input type="number" class="totalInput" readonly></td>`;
    tbody.appendChild(tr);

    const itemTypeSelect=card.querySelector('.itemTypeSelect');
    const sizeInput=tr.querySelector('.sizeInput');
    const weightInput=tr.querySelector('.weightInput');
    const nosInput=tr.querySelector('.nosInput');
    const mtInput=tr.querySelector('.mtInput');

    attachSuggestion(sizeInput,itemTypeSelect,weightInput,card);

    weightInput.addEventListener('input',()=>{
      recalcItemTotals(card);
      updateEffectiveTotalQty();
    });

    nosInput.addEventListener('input',()=>{
      tr.dataset.lastEdited = 'nos';
      recalcItemTotals(card);
      updateEffectiveTotalQty();
    });

    // LISTENER FOR THE NEW MT COLUMN WRITES
    mtInput.addEventListener('input',()=>{
      tr.dataset.lastEdited = 'mt';
      recalcItemTotals(card);
      updateEffectiveTotalQty();
    });

    updateLabelsForCard(card);
  }

  function createItemCard(index){
    const card=document.createElement('div'); card.className='item-card';
    card.innerHTML=`
      <div class="item-card-header">
        <div class="item-label">
          <div class="item-index-chip">${index}</div>
          <div>
            <div class="item-label-title">Item #${index}</div>
            <div class="item-label-sub">Select item, order type & rates</div>
          </div>
        </div>
        <button type="button" class="btn-chip removeItemBtn">âœ• Remove</button>
      </div>

      <div class="row">
        <div class="field">
          <label>Item <span class="sub">Category</span></label>
          <select class="itemTypeSelect">
            <option value="">Loading...</option>
          </select>
        </div>

        <div class="field">
          <label>Order Type</label>
          <select class="orderTypeSelect">
            <option value="">Select</option>
            <option value="Bill">Bill</option>
            <option value="NC">NC</option>
          </select>
        </div>

        <div class="field">
          <label>Rate Type <span class="sub">Basic / Net</span></label>
          <select class="rateTypeSelect">
            <option value="">Select</option>
            <option value="Basic">Basic Rate</option>
            <option value="Net">Netrate</option>
          </select>
        </div>
        <div class="field">
          <label class="rateLabel">Rate</label>
          <input type="number" class="rateValue" step="0.01" placeholder="Enter rate">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Basic Rate (Auto)</label>
          <input type="number" class="basicRateValue" readonly placeholder="Auto from Netrate">
        </div>
      </div>

      <div class="row row-manual">
        <div class="field" style="flex:1 1 260px">
          <label>
            <span>Enter Total Qty Manually</span>
            <span class="sub">Skip sizes</span>
          </label>
          <div class="manualToggleBar">
            <div class="manualToggleWrapper">
              <input type="checkbox" class="manualQtyToggle">
              <span class="manualToggleCaption">Auto / Manual</span>
            </div>
            <div class="manualModeHint">
              <span class="hint-auto">This is only for Sauda Booking (sizes not required).</span>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="manualQtyLabel">Manual Total Qty</label>
          <input type="number" class="manualQtyValue" step="0.001" placeholder="0" disabled>
          <div class="note manualNote"></div>
        </div>
      </div>

      <table class="itemTable">
        <thead>
          <tr>
            <th>#</th><th>Size</th><th class="perHeader">Per (Kg / Qty)</th><th class="mtCol">MT</th><th>Nos</th><th>Total Item Qty</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="5" class="itemTotalLabel">0.000</td></tr>
        </tfoot>
      </table>
      <div class="sizes-footer">
        <button type="button" class="btn-small addSizeBtn">+ Add Size</button>
        <button type="button" class="btn-small resetSizeBtn" style="background:#6b7280;">â†º Reset Sizes</button>
      </div>
    `;

    const itemTypeSelect=card.querySelector('.itemTypeSelect');
    const orderTypeSelect=card.querySelector('.orderTypeSelect');
    const rateTypeSelect=card.querySelector('.rateTypeSelect');
    const rateLabel=card.querySelector('.rateLabel');
    const rateInput=card.querySelector('.rateValue');
    const basicRateInput=card.querySelector('.basicRateValue');
    const itemTotalLabel=card.querySelector('tfoot .itemTotalLabel'); 
    const perHeader=card.querySelector('.perHeader');
    const manualToggle=card.querySelector('.manualQtyToggle');
    const manualInput=card.querySelector('.manualQtyValue');
    const manualLabel=card.querySelector('.manualQtyLabel');
    const manualNote=card.querySelector('.manualNote');
    const table=card.querySelector('.itemTable');

    if(ITEM_NAMES.length > 0) {
        itemTypeSelect.innerHTML = '<option value="">Select Item</option>';
        ITEM_NAMES.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            itemTypeSelect.appendChild(opt);
        });
    }

    function resetCardForNewItem(){
      manualToggle.checked = false;
      manualInput.disabled = true;
      manualInput.value = '';
      table.classList.remove('table-disabled');

      const tbody = card.querySelector('tbody');
      tbody.innerHTML = '';
      addSizeRow(card);
      card.querySelectorAll('tbody tr').forEach((r,i)=>r.querySelector('td:first-child').textContent=i+1);
      itemTotalLabel.textContent = '0.000'; 
      basicRateInput.value = '';
      updateEffectiveTotalQty();
    }

    function updateBasicRate(){
      const item = itemTypeSelect.value;
      const orderType = orderTypeSelect.value;
      const rateType = rateTypeSelect.value;
      const net = num(rateInput.value);

      if(!(item === 'Sqr Bar' || item === 'Round Bar' || item === 'Flat' || item === 'Binding Wire' || item === 'Nails')){
        basicRateInput.value = '';
        return;
      }

      if(rateType !== 'Net' || !net){
        basicRateInput.value = '';
        return;
      }

      if(orderType !== 'Bill' && orderType !== 'NC'){
        basicRateInput.value = '';
        return;
      }

      let basic;
      if(item === 'Binding Wire' || item === 'Nails'){
        basic = (net / 1.18) - 255;
      } else {
        if(orderType === 'Bill'){
          basic = (net / 1.18) - 255;
        } else { // NC
          basic = (net / 1.18) - 255 + 3000;
        }
      }
      basicRateInput.value = Math.round(basic);
    }

    function updateLabels(){
      const item=itemTypeSelect.value;
      const rt=rateTypeSelect.value;
      const rateWord=rt==='Basic'?'Basic Rate':rt==='Net'?'Netrate':'Rate';
      
      if (item === 'Sqr Bar') {
        rateLabel.textContent = 'Sqr Bar Rate';
      } else if (item === 'Round Bar') { 
        rateLabel.textContent = 'Round Bar Rate';
      } else {
        rateLabel.textContent = item ? `${item} ${rateWord}` : rateWord;
      }

      const isPieces=(item==='Bopp Tape'||item==='Cutting Wheels');
      const isMTOnly=(item==='Flat'||item==='Round Bar'||item==='Sqr Bar'); 
      const isDirectMT=(item==='Pipe'||item==='Angle'||item==='Channel');
      const isBinding=(item==='Binding Wire');
      const isNails=(item==='Nails');

      const headRow=card.querySelector('.itemTable thead tr');
      const mtCols=card.querySelectorAll('.mtCol');
      
      const perHeaderCell = headRow.children[2];
      const nosHeader = headRow.children[4];

      perHeaderCell.style.display='';
      nosHeader.style.display='';

      // 1. Text Labels
      if (item === 'Sqr Bar') {
          itemTotalLabel.textContent = `Total Sqr Bar Qty (MT)`;
      } else if (item === 'Round Bar') { 
          itemTotalLabel.textContent = `Total Round Bar Qty (MT)`;
      } else if(isPieces){
        itemTotalLabel.textContent=`Total ${item||'Item'} Qty (Pcs)`;
        perHeader.textContent='Pcs';
        headRow.children[4].textContent='Pcs/Box';
        manualLabel.textContent='Manual Total Qty (Pcs)';
        manualInput.step='1';
        manualNote.textContent='Pieces do not add to Effective Total Qty (MT).';
      }else if(isBinding){
        itemTotalLabel.textContent=`Total ${item||'Item'} Qty (MT)`;
        perHeader.textContent='Kg';
        headRow.children[4].textContent='Bundles';
        manualLabel.textContent='Manual Total Qty (MT)';
        manualInput.step='0.001';
        manualNote.textContent='';
      }else if(isDirectMT){
        itemTotalLabel.textContent=`Total ${item||'Item'} Qty (MT)`;
        perHeader.textContent='Kg/6 mtr';
        headRow.children[4].textContent='Nos';
        manualLabel.textContent='Manual Total Qty (MT)';
        manualInput.step='0.001';
        manualNote.textContent='';
      }else if(isNails){
        itemTotalLabel.textContent=`Total ${item||'Item'} Qty (MT)`;
        perHeader.textContent='Kg';
        headRow.children[4].textContent='Bags';
        manualLabel.textContent='Manual Total Qty (MT)';
        manualInput.step='0.001';
        manualNote.textContent='';
      }else{
        itemTotalLabel.textContent=`Total ${item||'Item'} Qty (MT)`;
        perHeader.textContent='Per (Kg / Qty)';
        headRow.children[4].textContent='Nos';
        manualLabel.textContent='Manual Total Qty (MT)';
        manualInput.step='0.001';
        manualNote.textContent='';
      }

      // 2. MT Column Visibility Logic
      // IMPORTANT CHANGE: We want MT shown for DirectMT (Pipes etc) to allow reverse calculation.
      // We also want it shown for MTOnly items.
      // We hide it for Pieces.
      const showMT = !isPieces; 
      mtCols.forEach(c=>c.style.display=showMT?'table-cell':'none');

      card.querySelectorAll('tbody tr').forEach(row=>{
        const perTd = row.children[2];
        const mtTd = row.children[3];
        const nosTd = row.children[4];
        const nosInput = row.querySelector('.nosInput');
        const weightInput = row.querySelector('.weightInput');

        if(isMTOnly){ 
          perHeaderCell.style.display='none';
          if(perTd) perTd.style.display='none';
          if(weightInput) weightInput.disabled=true;

          nosHeader.style.display='none';
          if(nosTd) nosTd.style.display='none';
          if(nosInput) nosInput.disabled=true;

          if(mtTd) mtTd.style.display='table-cell'; 
        } else { 
          if(perTd) perTd.style.display='table-cell';
          if(weightInput) weightInput.disabled=false;

          if(nosTd) nosTd.style.display='table-cell';
          if(nosInput) nosInput.disabled=false;
          
          if(mtTd) mtTd.style.display=showMT?'table-cell':'none';
        }
      });

      if (isMTOnly) {
          itemTotalLabel.colSpan = 3;
      } else {
          itemTotalLabel.colSpan = 4;
      }

      recalcItemTotals(card); 
      updateEffectiveTotalQty();
      updateBasicRate();
    }
    card.__updateLabels = updateLabels;

    function applyManualMode(){
      if(manualToggle.checked){
        manualInput.disabled=false;
        table.classList.add('table-disabled');
      }else{
        manualInput.disabled = true;
        manualInput.value = '';
        table.classList.remove('table-disabled');
      }
      recalcItemTotals(card); updateEffectiveTotalQty();
    }

    manualToggle.addEventListener('change',applyManualMode);
    manualInput.addEventListener('input',()=>{recalcItemTotals(card);updateEffectiveTotalQty();});

    itemTypeSelect.addEventListener('change', ()=>{
      resetCardForNewItem();
      updateLabels();
      updateBasicRate();
    });

    rateTypeSelect.addEventListener('change',()=>{
      updateLabels();
      updateBasicRate();
    });

    orderTypeSelect.addEventListener('change',()=>{
      updateBasicRate();
    });

    rateInput.addEventListener('input',()=>{
      updateBasicRate();
    });

    addSizeRow(card);

    card.querySelector('.addSizeBtn').addEventListener('click',()=>{
      addSizeRow(card);
      card.querySelectorAll('tbody tr').forEach((r,i)=>r.querySelector('td:first-child').textContent=i+1);
    });

    card.querySelector('.resetSizeBtn').addEventListener('click', () => {
      const tbody = card.querySelector('tbody');
      tbody.innerHTML = '';
      addSizeRow(card);
      card.querySelectorAll('tbody tr').forEach((r,i)=>r.querySelector('td:first-child').textContent=i+1);
      recalcItemTotals(card);
      updateEffectiveTotalQty();
    });

    card.querySelector('.removeItemBtn').addEventListener('click',()=>{
      itemsContainer.removeChild(card);
      renumberCards();
      updateEffectiveTotalQty();
    });

    updateLabels();
    return card;
  }

  function updateLabelsForCard(card){
    if(typeof card.__updateLabels==='function'){ card.__updateLabels(); }
  }

  function recalcItemTotals(card){
    const item=card.querySelector('.itemTypeSelect').value;
    const isPieces=(item==='Bopp Tape'||item==='Cutting Wheels');
    const isMTOnly=(item==='Flat'||item==='Round Bar'||item==='Sqr Bar');
    const isDirectMT=(item==='Pipe'||item==='Angle'||item==='Channel');
    const isBinding=(item==='Binding Wire');
    const isNails=(item==='Nails');
    const manualOn=card.querySelector('.manualQtyToggle').checked;
    const manualVal=num(card.querySelector('.manualQtyValue').value);
    let total=0;

    if(manualOn){
      total = manualVal || 0;
    }else{
      card.querySelectorAll('tbody tr').forEach(row=>{
        const per=num(row.querySelector('.weightInput').value);
        const nosInput=row.querySelector('.nosInput');
        const mtInput=row.querySelector('.mtInput');
        const totalInput=row.querySelector('.totalInput');

        if(isMTOnly && mtInput){ 
          const mtVal = num(mtInput.value);
          totalInput.value = mtVal ? mtVal.toFixed(3) : '';
          total += mtVal || 0;
          return; 
        }

        let mtVal=0, nosVal=num(nosInput.value);

        // Logic for Reverse Calculation (Type MT -> Get Nos)
        // Works for DirectMT (Pipes), Binding Wire, Nails
        if((isDirectMT || isBinding || isNails || !isPieces) && mtInput){ 
          const last = row.dataset.lastEdited || 'nos';
          const mtTypedStr = mtInput.value;
          const mtTyped = num(mtTypedStr);

          // If user edited the MT column
          if(last === 'mt'){
            if(mtTypedStr !== ''){
              
              // --- CHANGED LOGIC START ---
              // If weight (per) is 0 or empty, DIRECTLY COPY MT input to Total.
              // This allows manual override for items without defined weights.
              if (per <= 0) {
                 mtVal = mtTyped;
                 nosInput.value = ''; // Clear Nos since it's irrelevant without weight
              } else {
                 // Normal behavior: Calculate Nos from MT
                 const rawNos = (mtTyped * 1000) / per;
                 nosVal = Math.ceil(rawNos - 1e-9);
                 nosInput.value = nosVal || '';
                 mtVal = mtTyped;
              }
              // --- CHANGED LOGIC END ---

            } else {
              mtVal = 0;
              totalInput.value = '';
            }
          } else {
            // Standard: User edited Nos -> Calc MT
            const raw = per * nosVal;
            mtVal = raw/1000;
            mtInput.value = mtVal ? mtVal.toFixed(3) : '';
          }

          totalInput.value = mtVal ? mtVal.toFixed(3) : '';
          total += mtVal || 0;
        } else { 
          // Fallback or Pieces
          const raw = per * nosVal;
          const display = isPieces ? raw : raw/1000;
          totalInput.value = display ? (isPieces ? raw : display.toFixed(3)) : '';
          total += display || 0;
        }
      });
    }
    card.querySelector('tfoot .itemTotalLabel').textContent=total.toFixed(3);
  }

  function computeAllItemsTotal(){
    let sum=0;
    document.querySelectorAll('.item-card').forEach(card=>{
      const item=card.querySelector('.itemTypeSelect').value;
      if(!item) return;
      if(item==='Bopp Tape'||item==='Cutting Wheels') return; 
      sum += num(card.querySelector('tfoot .itemTotalLabel').textContent); 
    });
    return sum;
  }
  function updateEffectiveTotalQty(){ totalQtyHeader.value = computeAllItemsTotal().toFixed(3); }

  function addItemCard(){
    const existing=document.querySelectorAll('.item-card').length;
    if(existing>=MAX_ITEMS){alert(`You can add maximum ${MAX_ITEMS} items.`);return null;}
    const card=createItemCard(existing+1);
    itemsContainer.appendChild(card);
    return card;
  }
  function renumberCards(){
    document.querySelectorAll('.item-card').forEach((c,i)=>{
      c.querySelector('.item-index-chip').textContent=i+1;
      c.querySelector('.item-label-title').textContent=`Item #${i+1}`;
    });
  }

  addItemBtn.addEventListener('click',addItemCard);

  // ---------- DATE FORMATTER FOR WHATSAPP (DD/MM/YYYY) ----------
  function formatDisplayDate(isoStr) {
    if (!isoStr) return '-';
    const parts = isoStr.split('-'); 
    if (parts.length !== 3) return isoStr;
    const [yyyy, mm, dd] = parts;
    return `${dd}/${mm}/${yyyy}`;
  }

  // ---------- WHATSAPP MESSAGE BUILDER ----------
  function buildWhatsAppMessage(includeDetails) {

    const bookingDateRaw = document.getElementById('bookingDate').value || '';
    const bookingDate    = formatDisplayDate(bookingDateRaw);
    const firmName       = document.getElementById('firmName').value || '-';
    const vehicleNumber  = document.getElementById('vehicleNumber').value.trim();
    const remarks        = document.getElementById('remarks').value || '';
    const effQty         = totalQtyHeader.value || '0';

    const SEP = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€";

    function formatQty(val, isPcs) {
      const n = parseFloat(val || 0);
      if (isNaN(n)) return isPcs ? '0' : '0.000';
      return isPcs ? String(n) : n.toFixed(3);
    }

    let msg = "";

    // HEADER
    msg += `*Sauda Booking*\n`;
    msg += `Date: ${bookingDate}\n`;
    msg += `*Firm: ${firmName}*\n`;
    if (vehicleNumber) msg += `Vehicle No.: ${vehicleNumber}\n`;
    msg += `*Total Qty (MT): ${effQty} MT*\n\n`;

    const cards = [...document.querySelectorAll(".item-card")];

    cards.forEach((card, idx) => {

      const item          = card.querySelector(".itemTypeSelect").value;
      const orderType     = card.querySelector(".orderTypeSelect").value || "-";
      const rateTypeRaw = card.querySelector(".rateTypeSelect").value || "";
      const rate        = card.querySelector(".rateValue").value || "";
      const basicRate   = card.querySelector(".basicRateValue").value || "";
      const totalStr    = card.querySelector('tfoot .itemTotalLabel').textContent || "0"; 
      const total       = num(totalStr);

      if (!item || total == 0) return;

      const isPcs = (item === "Bopp Tape" || item === "Cutting Wheels");
      const unit  = isPcs ? "Pcs" : "MT";

      const rateType =
        rateTypeRaw === "Basic" ? "Basic Rate" :
        rateTypeRaw === "Net"   ? "Netrate"    :
        rateTypeRaw;

      // ITEM HEADER BLOCK
      msg += `*Item #${idx+1}: ${item}*\n`;
      msg += `Order Type: *${orderType}*\n`;
      if (rateType) msg += `Rate Type: ${rateType}\n`;
      if (rate)     msg += `Rate: ${rate}\n`;
      if (basicRate) msg += `Basic Rate (Auto): ${basicRate}\n`;
      
      // SHOW TOTAL
      msg += `*Total ${item} Qty: ${formatQty(totalStr, isPcs)} ${unit}*\n`; 

      // ONLY SHOW DETAILS IF REQUESTED
      if (includeDetails) {
        msg += `\n`; 
        const rows = [...card.querySelectorAll("tbody tr")];
        const list = [];

        rows.forEach((row, i) => {
          const sizeRaw = row.querySelector(".sizeInput").value.trim();
          const perVal  = row.querySelector(".weightInput").value.trim();
          const nosVal  = row.querySelector(".nosInput").value.trim();
          const qtyRaw  = row.querySelector(".totalInput").value.trim();

          if (!sizeRaw && !qtyRaw) return;

          let sizeShort = sizeRaw;
          const prefix = item + " ";
          if (sizeRaw.toLowerCase().startsWith(prefix.toLowerCase())) {
            sizeShort = sizeRaw.slice(prefix.length);
          }

          let formula = "";
          if (isPcs) {
            formula = `${perVal} x ${nosVal} = ${formatQty(qtyRaw, true)} Pcs`;
          } else {
            const nosLabel =
              item === "Binding Wire" ? "Bundles" :
              item === "Nails"        ? "Bags" :
              "Nos";
            
            if (item === 'Sqr Bar' || item === 'Flat' || item === 'Round Bar') { 
                if(!nosVal || nosVal == 0) {
                     formula = `= ${formatQty(qtyRaw, false)} MT`;
                } else {
                     formula = `${perVal}kg x ${nosVal} ${nosLabel} = ${formatQty(qtyRaw, false)} MT`;
                }
            } else if (item === 'Pipe' || item === 'Angle' || item === 'Channel') {
                // CHANGED: IF weight (perVal) is missing, don't show the calculation, just the total.
                if(!perVal || parseFloat(perVal) === 0) {
                    formula = `= ${formatQty(qtyRaw, false)} MT`;
                } else {
                    formula = `${perVal}kg/6mtr x ${nosVal} Nos = ${formatQty(qtyRaw, false)} MT`;
                }
            } else {
                formula = `${perVal}kg x ${nosVal} ${nosLabel} = ${formatQty(qtyRaw, false)} MT`;
            }
          }

          list.push({
            sr: i + 1,
            size: sizeShort,
            formula
          });
        });

        if (list.length) {
          msg += `*Details:*\n`;
          list.forEach(r => {
            let sizeText = r.size;
            const normItem = (item || '').toLowerCase().replace(/[.\s]/g, '');
            const normSize = (r.size || '').toLowerCase().replace(/[.\s]/g, '');
            if (normItem && !normSize.startsWith(normItem)) {
              sizeText = `${item} ${r.size}`;
            }
            msg += `${r.sr}. ${sizeText} ${r.formula}\n`;
          });
        }
      }

      msg += `\n${SEP}\n`;
    });

    if (remarks.trim()) {
      msg += `\n*Remarks:*\n${remarks.trim()}\n`;
    }

    msg += `\nThank you for your order!`;

    return msg;
  }

  function shareOnWhatsApp(includeDetails){
    const dRaw=bookingDateEl.value.trim();
    if(!dRaw){alert('Please select Booking Date.');return;}
    const chosen=new Date(dRaw); chosen.setHours(0,0,0,0);
    const today=new Date(); today.setHours(0,0,0,0);
    if(chosen>today){
      alert('Booking Date cannot be in the future.');
      bookingDateEl.value=isoDateOnly(today);
      bookingDateEl.focus(); return;
    }

    const f=document.getElementById('firmName').value.trim();
    if(!f){alert('Please enter Firm Name.');return;}

    let missingOrderType=false;
    document.querySelectorAll('.item-card').forEach(card=>{
      const item=card.querySelector('.itemTypeSelect').value.trim();
      const orderType=card.querySelector('.orderTypeSelect').value.trim();
      const total=num(card.querySelector('tfoot .itemTotalLabel').textContent||0); 
      if(item && total>0 && !orderType){
        missingOrderType=true;
      }
    });
    if(missingOrderType){
      alert('Please select Order Type (Bill / NC) for all items with quantity.');
      return;
    }

    const message=buildWhatsAppMessage(includeDetails);
    const encoded=encodeURIComponent(message);
    const url=`https://wa.me/?text=${encoded}`;
    window.open(url,'_blank');
  }

  // --- AUTO-SAVE FEATURE ---
  const saveFields = ['firmName', 'vehicleNumber', 'remarks'];

  saveFields.forEach(id => {
    const el = document.getElementById(id);
    if(el) {
      const saved = localStorage.getItem('sauda_' + id);
      if(saved) el.value = saved;
      el.addEventListener('input', () => {
        localStorage.setItem('sauda_' + id, el.value);
      });
    }
  });

  function resetForm(){
    if(!confirm('Clear all data and saved history?')) return;
    saveFields.forEach(id => localStorage.removeItem('sauda_' + id));
    document.querySelectorAll('input,textarea,select').forEach(el=>{
      if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
    });
    itemsContainer.innerHTML='';
    initializeApp(); 
    const today=new Date();
    bookingDateEl.max=isoDateOnly(today);
    bookingDateEl.value=isoDateOnly(today);
    totalQtyHeader.value='';
  }

  window.shareOnWhatsApp = shareOnWhatsApp;
  window.resetForm = resetForm;
  
  async function initializeApp() {
    await fetchLiveItems(); 
    addItemCard(); 
  }

  initializeApp(); 
</script>
</body>
</html>
